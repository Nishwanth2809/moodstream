<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodify: Let Your Mood Choose the Music</title>

    <!-- Spotify SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Whisper WebGPU Transformers -->
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers/dist/transformers.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #1e1e2e;
            color: white;
            margin: 0;
            padding: 0;
        }

        h1 {
            margin-top: 20px;
        }

        .input-container input[type="text"],
        .input-container select {
            margin-bottom: 10px;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 16px;
            width: 60%;
            border-radius: 5px;
            border: none;
        }

        select {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            margin-left: 5px;
        }

        button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }

        #analyzeTextButton {
            background-color: #3498db;
            color: white;
        }

        #recordButton {
            background-color: #ff4757;
            color: white;
        }

        #recordButton.recording {
            background-color: #2ed573;
        }

        #clearButton {
            background-color: #888;
            color: white;
        }

        #loading {
            display: none;
            font-size: 16px;
            margin-top: 15px;
        }

        #loading::after {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-left: 10px;
            border: 2px solid white;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #recordingTime {
            margin-top: 5px;
            font-size: 14px;
            display: none;
        }

        #moodResult {
            font-size: 20px;
            margin-top: 20px;
            font-weight: bold;
        }

        #songList {
            margin-top: 20px;
        }

        .song {
            margin: 10px;
            padding: 10px;
            background-color: #2c2c54;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-in;
            flex-wrap: wrap;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .song img {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            margin-right: 10px;
        }

        @media (max-width: 600px) {
            input[type="text"] { width: 90%; }
            .song { flex-direction: column; text-align: center; }
            .song img { margin-bottom: 10px; }
        }
    </style>
</head>

<body>
    <h1>Moodify: Let Your Mood Choose the Music</h1>

    <div class="input-container">
        <input type="text" id="textInput" placeholder="Type your mood or thoughts..." />
        <br><br>

        <select id="languageSelect">
            <option value="english">English</option>
            <option value="hindi">Hindi</option>
            <option value="telugu">Telugu</option>
        </select>
        <br><br>

        <button id="analyzeTextButton">Analyze Mood</button>
        <button id="clearButton">Clear</button>
    </div>

    <button id="recordButton">üéô Start Recording</button>
    <p id="recordingTime"></p>
    <p id="loading">Processing... Please wait ‚è≥</p>

    <div id="moodResult"></div>
    <div id="songList"></div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime;
        let timerInterval;

        // -------------------------------
        // Load Whisper WebGPU Model
        // -------------------------------
        let whisperModel;
        let whisperLoaded = false;

        async function loadWhisper() {
            if (!whisperLoaded) {
                $("#loading").show().text("Loading voice model... (first time only)");

                whisperModel = await transformers.pipeline(
                    "automatic-speech-recognition",
                    "Xenova/whisper-tiny.en",
                    { dtype: "fp32" }
                );

                whisperLoaded = true;
                $("#loading").hide();
            }
        }
        loadWhisper();

        // -------------------------------
        // Recording Logic
        // -------------------------------
        $("#recordButton").click(function () {
            if (!isRecording) startRecording();
            else stopRecording();
        });

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();

                    isRecording = true;
                    recordingStartTime = Date.now();
                    $("#recordButton").addClass("recording").text("‚èπ Stop Recording");
                    $("#recordingTime").show();

                    updateTimer();
                    timerInterval = setInterval(updateTimer, 500);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                    mediaRecorder.onstop = () => {
                        clearInterval(timerInterval);
                        $("#recordingTime").hide();
                        processAudio();
                    };
                })
                .catch(() => alert("Microphone access denied!"));
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            $("#recordButton").removeClass("recording").text("üéô Start Recording");
        }

        function updateTimer() {
            let elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            $("#recordingTime").text(`Recording... ${elapsed}s`);
        }

        // -------------------------------
        // Whisper-Based Browser STT
        // -------------------------------
        async function processAudio() {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

            $("#loading").show().text("Transcribing voice...");

            const arrayBuffer = await audioBlob.arrayBuffer();
            const audioData = new Float32Array(arrayBuffer);

            const result = await whisperModel(audioData);
            const text = result.text;
            $("#textInput").val(text);

            $("#loading").show().text("Analyzing mood...");

            // Send TEXT to backend for mood + songs
            $.ajax({
                url: "/text",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    text: text,
                    language: $("#languageSelect").val()
                }),
                success: function (response) {
                    $("#loading").hide();
                    displayResults(response);
                },
                error: function () {
                    $("#loading").hide();
                    $("#moodResult").text("Error analyzing mood");
                }
            });
        }

        // -------------------------------
        // Text Button
        // -------------------------------
        $("#analyzeTextButton").click(function () {
            let text = $("#textInput").val().trim();
            if (text === "") return alert("Please enter some text.");

            $("#loading").show();
            $("#moodResult, #songList").empty();

            $.ajax({
                url: "/text",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    text: text,
                    language: $("#languageSelect").val()
                }),
                success: function (response) {
                    $("#loading").hide();
                    displayResults(response);
                },
                error: function () {
                    $("#loading").hide();
                    $("#moodResult").text("Error analyzing mood");
                }
            });
        });

        $("#clearButton").click(() => {
            $("#textInput").val("");
            $("#moodResult").empty();
            $("#songList").empty();
        });

        // -------------------------------
        // Display Results
        // -------------------------------
        function displayResults(response) {
            if (response.error) {
                $("#moodResult").text("Error: " + response.error);
                return;
            }

            $("#moodResult").html(`Detected Mood: <b>${response.mood.toUpperCase()}</b>`);

            if (response.songs?.length) {
                $("#songList").html("<h3>Recommended Songs üé∂</h3>");
                response.songs.forEach(song => {
                    $("#songList").append(`
                        <div class="song">
                            <img src="${song.cover}">
                            <b>${song.name}</b> by ${song.artist}
                            <button onclick="playSong('${song.spotify_uri}')">‚ñ∂ Play</button>
                            <br><a href="${song.spotify_url}" target="_blank">Open in Spotify</a>
                        </div>
                    `);
                });
            } else {
                $("#songList").html("<p>No songs found for this mood.</p>");
            }
        }

        // -------------------------------
        // Spotify Playback
        // -------------------------------
        window.onSpotifyWebPlaybackSDKReady = () => {
            const token = "{{ session.get('access_token', '') }}";
            if (!token) {
                alert("Please log in to Spotify!");
                return;
            }

            const player = new Spotify.Player({
                name: "Mood-Based Music Player",
                getOAuthToken: cb => cb(token),
                volume: 0.5
            });

            player.addListener("ready", ({ device_id }) => {
                window.deviceId = device_id;
            });

            player.connect();

            window.playSong = function (trackUri) {
                fetch(`https://api.spotify.com/v1/me/player/play?device_id=${window.deviceId}`, {
                    method: "PUT",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ uris: [trackUri] })
                }).then(res => {
                    if (!res.ok) alert("Failed to play song. Spotify Premium required.");
                });
            };
        };
    </script>
</body>
</html>