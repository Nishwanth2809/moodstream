<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodify: Let Your Mood Choose the Music</title>

    <!-- Spotify SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Browser Whisper -->
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers/dist/transformers.min.js"></script>

    <style>
        body {
            font-family: Arial;
            background: #1e1e2e;
            color: white;
            text-align: center;
            padding: 0;
            margin: 0;
        }
        input, select {
            padding: 10px;
            width: 60%;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 5px;
            border: none;
        }
        button {
            padding: 12px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        #recordButton {
            background: #ff4757;
            color: white;
        }
        #recordButton.recording {
            background: #2ed573;
        }
        #loading {
            font-size: 16px;
            margin-top: 15px;
            display: none;
        }
        .song {
            background: #2c2c54;
            padding: 10px;
            margin: 10px auto;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .song img {
            width: 50px;
            height: 50px;
            border-radius: 5px;
        }
    </style>
</head>

<body>

<h1>Moodify: Let Your Mood Choose the Music</h1>

<input type="text" id="textInput" placeholder="Type something..." />

<select id="languageSelect">
    <option value="english">English</option>
    <option value="hindi">Hindi</option>
    <option value="telugu">Telugu</option>
</select>

<br>
<button onclick="analyzeText()">Analyze Text</button>
<button id="recordButton">ðŸŽ™ Start Recording</button>

<p id="loading">Processing... Please wait ðŸ”„</p>

<div id="moodResult"></div>
<div id="songList"></div>

<script>
let whisperPipe;
let mediaRecorder;
let audioChunks = [];
let isRecording = false;

// Load Whisper ONCE
async function loadWhisper() {
    if (!whisperPipe) {
        whisperPipe = await transformers.pipeline(
            "automatic-speech-recognition",
            "Xenova/whisper-tiny.en"
        );
        console.log("Whisper loaded.");
    }
}

/* ------------------------------
    TEXT INPUT
------------------------------ */
function analyzeText() {
    let text = $("#textInput").val().trim();
    let language = $("#languageSelect").val();

    if (!text) return alert("Enter some text");

    $("#loading").show();
    $("#moodResult").empty();
    $("#songList").empty();

    $.ajax({
        url: "/text",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ text, language }),
        success: displayResults
    }).always(() => $("#loading").hide());
}

/* ------------------------------
    VOICE INPUT
------------------------------ */
$("#recordButton").click(async () => {
    if (!isRecording) startRecording();
    else stopRecording();
});

async function startRecording() {
    await loadWhisper();

    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.start();
        isRecording = true;

        $("#recordButton").text("â¹ Stop Recording").addClass("recording");

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = () => processRecording();
    });
}

function stopRecording() {
    mediaRecorder.stop();
    isRecording = false;
    $("#recordButton").text("ðŸŽ™ Start Recording").removeClass("recording");
}

async function processRecording() {
    $("#loading").show();

    let audioBlob = new Blob(audioChunks, { type: "audio/webm" });

    // Convert blob to form Whisper input
    const audioBuffer = await audioBlob.arrayBuffer();
    const audioData = new Float32Array(audioBuffer);

    // Run Whisper on browser
    const result = await whisperPipe(audioData);
    const text = result.text.trim();
    const language = $("#languageSelect").val();

    // Send only text to backend
    $.ajax({
        url: "/voice",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ text, language }),
        success: displayResults
    }).always(() => $("#loading").hide());
}

/* ------------------------------
    DISPLAY RESULTS
------------------------------ */
function displayResults(response) {
    if (response.error) {
        $("#moodResult").text("Error: " + response.error);
        return;
    }

    $("#moodResult").html(`Detected Mood: <b>${response.mood.toUpperCase()}</b>`);

    $("#songList").empty();

    response.songs.forEach(s => {
        $("#songList").append(`
            <div class="song">
                <img src="${s.cover}">
                <div><b>${s.name}</b><br>${s.artist}</div>
                <a href="${s.spotify_url}" target="_blank">â–¶</a>
            </div>
        `);
    });
}
</script>

</body>
</html>
