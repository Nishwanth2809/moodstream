<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodify - Let Your Mood Choose the Music</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            background-color: #1e1e2e;
            color: white;
            text-align: center;
            font-family: Arial;
            padding: 20px;
        }
        h1 { margin-bottom: 20px; }

        input, select {
            padding: 10px;
            width: 60%;
            border-radius: 6px;
            border: none;
            margin-top: 10px;
        }
        button {
            padding: 12px 16px;
            border: none;
            border-radius: 5px;
            margin: 10px;
            cursor: pointer;
            font-size: 16px;
        }
        #recordButton { background: #ff4757; color: white; }
        #recordButton.recording { background: #2ed573; }
        #analyzeTextButton { background: #3498db; color: white; }
        #clearButton { background: #888; color: white; }

        #songList .song {
            background: #2c2c54;
            padding: 10px;
            margin: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .song img {
            width: 50px;
            height: 50px;
            border-radius: 6px;
        }
    </style>
</head>

<body>

    <h1>Moodify â€” Let Your Mood Choose Music ðŸŽµ</h1>

    <input type="text" id="textInput" placeholder="Type your mood...">

    <br>
    <select id="languageSelect">
        <option value="english">English</option>
        <option value="hindi">Hindi</option>
        <option value="telugu">Telugu</option>
    </select>

    <br>
    <button id="analyzeTextButton">Analyze Mood</button>
    <button id="clearButton">Clear</button>

    <br><br>
    <button id="recordButton">ðŸŽ™ Start Recording</button>

    <p id="status"></p>

    <h2 id="moodResult"></h2>
    <div id="songList"></div>

<script>
let mediaRecorder;
let chunks = [];
let isRecording = false;

// ---------------------------
// Start / Stop Recording
// ---------------------------
document.getElementById("recordButton").onclick = function () {
    if (!isRecording) startRecording();
    else stopRecording();
};

async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    chunks = [];
    mediaRecorder.start();
    isRecording = true;

    document.getElementById("recordButton").classList.add("recording");
    document.getElementById("recordButton").innerText = "â¹ Stop Recording";
    document.getElementById("status").innerText = "Recording... ðŸŽ™";

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => processAudio();
}

function stopRecording() {
    mediaRecorder.stop();
    isRecording = false;

    document.getElementById("recordButton").classList.remove("recording");
    document.getElementById("recordButton").innerText = "ðŸŽ™ Start Recording";
    document.getElementById("status").innerText = "Processing audio...";
}

// ---------------------------
// Convert audio â†’ Base64
// ---------------------------
async function processAudio() {
    const blob = new Blob(chunks, { type: "audio/webm" });
    const reader = new FileReader();

    reader.onloadend = () => {
        let base64Audio = reader.result.split(",")[1];

        document.getElementById("status").innerText = "Sending to server...";

        $.ajax({
            url: "/voice",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                audio: base64Audio,
                language: document.getElementById("languageSelect").value
            }),
            success: showResults,
            error: () => alert("Error processing voice!")
        });
    };

    reader.readAsDataURL(blob);
}

// ---------------------------
// Text Input â†’ Mood Detection
// ---------------------------
document.getElementById("analyzeTextButton").onclick = function () {
    let text = document.getElementById("textInput").value.trim();
    let language = document.getElementById("languageSelect").value;

    if (!text) return alert("Enter text first.");

    $.ajax({
        url: "/text",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ text, language }),
        success: showResults
    });
};

// ---------------------------
// Display results
// ---------------------------
function showResults(response) {
    console.log(response);
    if (response.error) {
        document.getElementById("moodResult").innerText = "Error: " + response.error;
        return;
    }

    document.getElementById("status").innerText = "";

    document.getElementById("moodResult").innerHTML =
        `Detected Mood: <b>${response.mood.toUpperCase()}</b><br>
         <small>Text: ${response.text || "Voice detected"}</small>`;

    let list = document.getElementById("songList");
    list.innerHTML = "";

    if (!response.songs?.length) {
        list.innerHTML = "<p>No songs found.</p>";
        return;
    }

    response.songs.forEach(song => {
        list.innerHTML += `
            <div class="song">
                <img src="${song.cover}">
                <div>
                    <b>${song.name}</b><br>
                    ${song.artist}<br>
                    <a href="${song.spotify_url}" target="_blank">Open in Spotify</a>
                </div>
            </div>
        `;
    });
}

// ---------------------------
// Clear button
// ---------------------------
document.getElementById("clearButton").onclick = function () {
    document.getElementById("textInput").value = "";
    document.getElementById("moodResult").innerHTML = "";
    document.getElementById("songList").innerHTML = "";
    document.getElementById("status").innerHTML = "";
};
</script>

</body>
</html>
